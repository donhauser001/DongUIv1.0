# 用户系统完整指南

## 概述

用户系统提供了完整的用户管理功能，包括用户列表、详情查看、信息编辑、密码修改、头像上传等功能。系统采用 RBAC（基于角色的访问控制）模型，支持多种用户角色。

## 功能特性

### 1. 用户列表管理

- ✅ 用户列表展示（支持分页）
- ✅ 搜索功能（按姓名、邮箱）
- ✅ 角色筛选
- ✅ 状态筛选（启用/禁用）
- ✅ 快速操作（查看详情、删除）
- ✅ 用户状态切换
- ✅ 角色徽章显示
- ✅ **新增用户模态窗**（快速创建用户）

### 2. 用户详情与编辑

- ✅ 基本信息查看和编辑
- ✅ 角色管理
- ✅ 状态管理
- ✅ 创建/更新时间显示
- ✅ 超级管理员保护（不可删除、角色不可修改）

### 3. 密码管理

- ✅ 修改密码功能
- ✅ 密码强度实时检测
- ✅ 密码确认验证
- ✅ 密码要求提示
- ✅ 安全的密码加密（bcrypt）

### 4. 头像管理

- ✅ 头像上传（支持 JPG、PNG、GIF）
- ✅ 实时预览
- ✅ 文件大小验证（最大 2MB）
- ✅ Base64 编码存储
- ✅ 头像删除
- ✅ 默认头像（首字母）

## 用户角色

系统支持四种用户角色：

| 角色 | 代码 | 说明 | 权限 |
|------|------|------|------|
| 学生 | `STUDENT` | 普通学生用户 | 基础权限 |
| 教师 | `TEACHER` | 教师用户 | 教学管理权限 |
| 管理员 | `ADMIN` | 系统管理员 | 系统管理权限 |
| 超级管理员 | `SUPER_ADMIN` | 最高权限管理员 | 所有权限，不可删除 |

## 页面结构

### 用户列表页面 (`UserList.vue`)

```
/admin/user/list
```

**功能模块：**
1. **搜索栏**：按姓名或邮箱搜索
2. **筛选器**：按角色和状态筛选
3. **用户表格**：
   - 头像
   - 姓名
   - 邮箱
   - 角色徽章
   - 状态开关
   - 操作菜单（查看详情、删除）

### 用户详情页面 (`UserDetail.vue`)

```
/admin/user/:id
```

**Tab 导航：**
1. **基本信息**：查看和编辑用户基本资料
2. **修改密码**：为用户设置新密码
3. **头像设置**：上传、预览、删除头像

## 使用指南

### 创建新用户

#### 方式一：使用模态窗（推荐）

在用户列表页面点击"新增用户"按钮，会弹出创建用户模态窗：

**模态窗功能：**
- 用户名输入（必填）
- 邮箱输入（必填，自动验证格式）
- 密码输入（必填，至少 6 位）
- 密码强度实时检测
- 角色选择（学生/教师/管理员/超级管理员）
- 表单验证和错误提示

**创建流程：**
1. 点击"新增用户"按钮
2. 填写用户信息
3. 查看密码强度提示
4. 点击"确认创建"
5. 自动刷新用户列表

#### 方式二：使用 API（编程方式）

```typescript
import { createUser } from '@/api/user'

const newUser = await createUser({
  name: '张三',
  email: 'zhangsan@example.com',
  password: 'password123',
  role: 'STUDENT',
  avatar: 'data:image/png;base64,...' // 可选
})
```

### 更新用户信息

```typescript
import { updateUser } from '@/api/user'

const updated = await updateUser('user-id', {
  name: '李四',
  email: 'lisi@example.com',
  role: 'TEACHER',
  status: true
})
```

### 修改用户密码

```typescript
import { updateUser } from '@/api/user'

await updateUser('user-id', {
  password: 'newPassword123'
})
```

### 上传用户头像

```typescript
// 1. 读取文件并转换为 Base64
const file = event.target.files[0]
const reader = new FileReader()

reader.onload = async (e) => {
  const base64 = e.target.result as string
  
  // 2. 更新用户头像
  await updateUser('user-id', {
    avatar: base64
  })
}

reader.readAsDataURL(file)
```

### 删除用户头像

```typescript
await updateUser('user-id', {
  avatar: null
})
```

## 密码强度检测

系统提供实时密码强度检测功能，根据以下规则评估密码强度：

**评分标准：**
- 长度 ≥ 8 个字符：+1 分
- 长度 ≥ 12 个字符：+1 分
- 包含大小写字母：+1 分
- 包含数字：+1 分
- 包含特殊字符：+1 分

**强度等级：**
- **弱**（≤2 分）：红色 `#ef4444`
- **中**（3 分）：橙色 `#f59e0b`
- **强**（≥4 分）：绿色 `#10b981`

**实现示例：**

```typescript
const passwordStrength = computed(() => {
  const password = passwordForm.value.newPassword
  if (!password) return { level: 0, text: '', color: '' }
  
  let strength = 0
  if (password.length >= 8) strength++
  if (password.length >= 12) strength++
  if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++
  if (/\d/.test(password)) strength++
  if (/[^a-zA-Z0-9]/.test(password)) strength++
  
  if (strength <= 2) return { level: strength, text: '弱', color: '#ef4444' }
  if (strength <= 3) return { level: strength, text: '中', color: '#f59e0b' }
  return { level: strength, text: '强', color: '#10b981' }
})
```

## 头像处理

### 文件验证

```typescript
const handleAvatarSelect = (event: Event) => {
  const file = event.target.files?.[0]
  
  // 验证文件类型
  if (!file.type.startsWith('image/')) {
    alert('请选择图片文件')
    return
  }
  
  // 验证文件大小（最大 2MB）
  if (file.size > 2 * 1024 * 1024) {
    alert('图片大小不能超过 2MB')
    return
  }
  
  // 生成预览
  const reader = new FileReader()
  reader.onload = (e) => {
    avatarPreview.value = e.target?.result as string
  }
  reader.readAsDataURL(file)
}
```

### Base64 编码

头像以 Base64 格式存储在数据库中，格式如下：

```
data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAA...
```

**优点：**
- 无需额外的文件存储服务
- 简化部署和维护
- 适合小尺寸头像

**注意事项：**
- 建议图片大小不超过 2MB
- Base64 编码后体积会增加约 33%
- 对于大量用户，建议使用 CDN 或对象存储

### 默认头像

如果用户没有上传头像，系统会显示用户名的首字母作为默认头像：

```typescript
const getAvatarDisplay = computed(() => {
  if (!user.value) return 'U'
  if (user.value.avatar) return user.value.avatar
  return user.value.name[0]?.toUpperCase() || 'U'
})
```

## 安全特性

### 1. 超级管理员保护

超级管理员账户具有特殊保护：

```typescript
// 后端保护
if (user.role === 'SUPER_ADMIN' && data.role && data.role !== 'SUPER_ADMIN') {
  throw new ConflictException('Cannot change super admin role');
}

if (user.role === 'SUPER_ADMIN') {
  throw new ConflictException('Cannot delete super admin user');
}
```

```typescript
// 前端提示
const isSuperAdmin = computed(() => user.value?.role === 'SUPER_ADMIN')

// 禁用角色选择
<select :disabled="!editing || isSuperAdmin">
  <!-- ... -->
</select>
```

### 2. 密码加密

使用 bcrypt 进行密码加密：

```typescript
import * as bcrypt from 'bcrypt';

// 创建用户时加密密码
const hashedPassword = await bcrypt.hash(data.password, 10);

// 更新密码时加密
if (data.password) {
  updateData.password = await bcrypt.hash(data.password, 10);
}
```

### 3. 邮箱唯一性验证

```typescript
// 检查邮箱是否已存在
const existingUser = await this.prisma.user.findUnique({
  where: { email: data.email },
});

if (existingUser) {
  throw new ConflictException('Email already exists');
}
```

## API 接口

### 获取用户列表

```
GET /api/users?search=keyword&role=STUDENT&status=true
```

**查询参数：**
- `search`：搜索关键词（姓名或邮箱）
- `role`：角色筛选
- `status`：状态筛选

**响应：**
```json
[
  {
    "id": "uuid",
    "email": "user@example.com",
    "name": "用户名",
    "avatar": "data:image/png;base64,...",
    "role": "STUDENT",
    "status": true,
    "createdAt": "2024-01-01T00:00:00.000Z",
    "updatedAt": "2024-01-01T00:00:00.000Z"
  }
]
```

### 获取单个用户

```
GET /api/users/:id
```

### 创建用户

```
POST /api/users
Content-Type: application/json

{
  "email": "user@example.com",
  "name": "用户名",
  "password": "password123",
  "role": "STUDENT",
  "avatar": "data:image/png;base64,..."
}
```

### 更新用户

```
PUT /api/users/:id
Content-Type: application/json

{
  "name": "新用户名",
  "email": "newemail@example.com",
  "role": "TEACHER",
  "status": true,
  "password": "newPassword123",
  "avatar": "data:image/png;base64,..."
}
```

### 切换用户状态

```
PATCH /api/users/:id/toggle-status
```

### 删除用户

```
DELETE /api/users/:id
```

### 获取用户统计

```
GET /api/users/stats
```

**响应：**
```json
{
  "total": 100,
  "active": 85,
  "inactive": 15,
  "byRole": [
    { "role": "STUDENT", "count": 60 },
    { "role": "TEACHER", "count": 30 },
    { "role": "ADMIN", "count": 9 },
    { "role": "SUPER_ADMIN", "count": 1 }
  ]
}
```

## 样式定制

用户系统的所有样式都使用 CSS 变量，可以通过主题系统进行定制：

```css
/* 用户头像 */
.user-avatar-large {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  background: var(--color-bg-tertiary);
}

/* 角色徽章 */
.role-badge {
  background: var(--color-bg-secondary);
  color: var(--color-text-primary);
  border: var(--border-width) solid var(--color-border);
}

/* 密码强度指示器 */
.strength-bar {
  background: var(--color-bg-tertiary);
}

.strength-fill {
  background-color: /* 动态颜色 */;
}
```

## 最佳实践

### 1. 密码要求

建议设置以下密码要求：
- 最小长度：6-8 个字符
- 包含大小写字母
- 包含数字
- 包含特殊字符
- 避免使用常见密码

### 2. 头像规范

- **格式**：JPG、PNG、GIF
- **大小**：不超过 2MB
- **尺寸**：建议 200x200 以上的正方形图片
- **压缩**：上传前进行适当压缩

### 3. 角色分配

- 谨慎分配管理员权限
- 定期审查用户角色
- 保持至少一个超级管理员账户
- 不要随意删除超级管理员

### 4. 数据验证

```typescript
// 前端验证
if (!form.value.email.includes('@')) {
  alert('请输入有效的邮箱地址')
  return
}

// 后端验证
if (!data.email || !data.email.includes('@')) {
  throw new BadRequestException('Invalid email address');
}
```

## 常见问题

### Q: 如何重置用户密码？

A: 在用户详情页面的"修改密码" Tab 中，输入新密码并确认即可。

### Q: 为什么无法删除某个用户？

A: 超级管理员账户受到保护，无法删除。如果需要删除，请先将其角色改为其他角色（但超级管理员角色本身也不可修改）。

### Q: 头像上传失败怎么办？

A: 检查以下几点：
1. 文件格式是否为图片（JPG、PNG、GIF）
2. 文件大小是否超过 2MB
3. 浏览器控制台是否有错误信息
4. 后端服务是否正常运行

### Q: 如何批量导入用户？

A: 目前系统不支持批量导入。如需批量导入，可以：
1. 使用数据库种子文件（`prisma/seed.ts`）
2. 编写脚本调用 API 接口
3. 直接操作数据库（不推荐）

### Q: 密码强度检测的标准是什么？

A: 参考本文档的"密码强度检测"章节，系统会根据密码长度、字符类型等因素综合评分。

## 相关文件

- `apps/web/src/views/admin/user/UserList.vue` - 用户列表页面
- `apps/web/src/views/admin/user/UserDetail.vue` - 用户详情页面
- `apps/web/src/api/user.ts` - 用户 API 接口
- `apps/server/src/user/user.service.ts` - 用户服务（后端）
- `apps/server/src/user/user.controller.ts` - 用户控制器（后端）
- `apps/server/prisma/schema.prisma` - 数据库模型定义

## 更新日志

### v1.1.0 (2024-11-24)

- ✅ 添加修改密码功能
- ✅ 添加密码强度实时检测
- ✅ 添加头像上传功能（Base64）
- ✅ 添加头像预览和删除
- ✅ 优化用户详情页面布局
- ✅ 添加 Tab 导航（基本信息、修改密码、头像设置）
- ✅ 改进表单验证和错误提示
- ✅ **添加新增用户模态窗**
- ✅ 模态窗中集成密码强度检测
- ✅ 表单验证和实时反馈

### v1.0.0 (2024-11-20)

- ✅ 初始版本
- ✅ 用户列表和详情
- ✅ 用户 CRUD 操作
- ✅ 角色管理
- ✅ 状态管理
- ✅ 超级管理员保护

