# 颜色初始化系统

## 概述

为了确保所有组件的颜色都能跟随当前选择的配色方案，我们实现了一个统一的颜色初始化系统。这个系统会在以下情况下自动初始化所有与颜色相关的配置：

1. **首次加载配置时**
2. **切换配色方案时**
3. **点击"恢复默认"时**

## 核心原理

### 1. 配色方案 ID 保存

当用户选择一个配色方案（如"商务蓝"、"活力橙"等）时，系统会：
- 将配色方案的所有颜色应用到 `config.colors`
- 保存配色方案的 ID 到 `config._currentSchemeId`

```typescript
// 在 SkinSettings.vue 中
const applyScheme = (scheme) => {
  // ... 应用颜色 ...
  props.config._currentSchemeId = scheme.id
}
```

### 2. 统一的颜色初始化函数

`utils/colorInit.ts` 提供了 `initializeColorsFromPrimary` 函数，用于根据主色初始化所有组件的颜色：

```typescript
export function initializeColorsFromPrimary(config: any, primaryColor: string) {
  // 计算悬停颜色（主色加深 10%）
  const hoverColor = calculateHoverColor(primaryColor)
  
  // 初始化按钮颜色
  config.button.primary.backgroundColor = primaryColor
  config.button.primary.borderColor = primaryColor
  config.button.primary.hoverBackgroundColor = hoverColor
  // ...
  
  // 初始化输入框颜色
  config.input.text.focusBorderColor = primaryColor
  // ...
  
  // 初始化表单元素颜色
  config.form.select.focusBorderColor = primaryColor
  config.form.checkbox.checkedBackgroundColor = primaryColor
  // ...
  
  // 初始化卡片颜色
  config.card.white.hoverBorderColor = primaryColor
  // ...
  
  // 初始化表格颜色
  config.table.actionMenu.triggerHoverColor = primaryColor
  // ...
}
```

### 3. 恢复默认的逻辑

点击"恢复默认"时，系统会：
1. 读取当前保存的配色方案 ID (`config._currentSchemeId`)
2. 读取当前的主色 (`config.colors.primary`)
3. 恢复所有非颜色配置到默认值
4. **保留**当前的颜色配置（不恢复到孟加拉绿）
5. 使用当前主色重新初始化所有组件颜色

```typescript
const resetToDefault = async () => {
  // 保留当前选择的配色方案
  const currentSchemeId = config.value._currentSchemeId || 'green'
  const currentPrimaryColor = config.value.colors?.primary || '#03624C'
  
  // 恢复所有配置，但跳过 colors
  Object.keys(freshConfig).forEach(key => {
    if (key === 'colors') return // 跳过颜色配置
    // ... 恢复其他配置 ...
  })
  
  // 恢复配色方案 ID
  config.value._currentSchemeId = currentSchemeId
  
  // 使用当前主色重新初始化所有组件颜色
  initializeColorsFromPrimary(config.value, currentPrimaryColor)
}
```

## 涉及的组件和配置

以下组件的颜色会自动跟随配色方案：

### 按钮 (`button`)
- 主要按钮：背景色、边框色、悬停背景色、悬停边框色
- 次要按钮：悬停边框色、悬停文字色

### 输入框 (`input`)
- 单行输入框：聚焦边框色、聚焦光圈色
- 多行文本框：聚焦边框色、聚焦光圈色
- 富文本编辑器：聚焦边框色、聚焦光圈色

### 表单元素 (`form`)
- 下拉框：聚焦边框色、聚焦光圈色
- 复选框：选中背景色、选中边框色
- 单选框：选中边框色、选中圆点色
- 开关：开启背景色

### 卡片 (`card`)
- 白底卡片：悬停边框色
- 黑底卡片：悬停边框色

### 表格 (`table`)
- 操作菜单：触发器悬停色

## 使用示例

### 在组件中使用

```typescript
import { initializeColorsFromPrimary } from '@/utils/colorInit'

// 当需要重新初始化颜色时
const primaryColor = config.value.colors.primary
initializeColorsFromPrimary(config.value, primaryColor)
```

### 添加新的颜色配置

如果你需要添加新的组件颜色配置，需要在 `utils/colorInit.ts` 中添加相应的初始化逻辑：

```typescript
export function initializeColorsFromPrimary(config: any, primaryColor: string) {
  // ... 现有代码 ...
  
  // 添加新组件的颜色初始化
  if (config.newComponent) {
    config.newComponent.primaryColor = primaryColor
    config.newComponent.hoverColor = hoverColor
  }
}
```

## 最佳实践

1. **不要硬编码颜色值**：所有与主色相关的颜色都应该使用 `var(--color-primary)` 或通过 `initializeColorsFromPrimary` 初始化

2. **保持一致性**：新增的颜色配置应该遵循现有的命名规范和初始化逻辑

3. **测试不同配色方案**：在添加新功能后，确保在不同配色方案下都能正常工作

4. **文档更新**：如果添加了新的颜色配置，记得更新本文档

## 故障排除

### 问题：切换配色方案后，某些组件颜色没有更新

**原因**：该组件的颜色初始化逻辑可能没有添加到 `initializeColorsFromPrimary` 函数中。

**解决方案**：在 `utils/colorInit.ts` 中添加该组件的颜色初始化逻辑。

### 问题：恢复默认后，颜色变成了孟加拉绿

**原因**：`resetToDefault` 函数可能没有正确保留当前的配色方案 ID。

**解决方案**：检查 `ComponentGallery.vue` 中的 `resetToDefault` 函数，确保 `_currentSchemeId` 被正确保存和恢复。

### 问题：首次加载时，某些组件颜色是空的

**原因**：`onMounted` 中可能没有调用 `initializeColorsFromPrimary`。

**解决方案**：在 `ComponentGallery.vue` 的 `onMounted` 钩子中确保调用了颜色初始化函数。

## 相关文件

- `apps/web/src/utils/colorInit.ts` - 颜色初始化工具函数
- `apps/web/src/views/admin/dev/ComponentGallery.vue` - 主题配置管理
- `apps/web/src/views/admin/dev/components/SkinSettings.vue` - 配色方案选择
- `apps/web/src/config/theme.ts` - 主题配置定义

