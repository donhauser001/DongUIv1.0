# åç«¯å¼€å‘æŒ‡å—

åŸºäº NestJS + Prisma + PostgreSQL çš„åç«¯æœåŠ¡å¼€å‘æŒ‡å—ã€‚

## ğŸ—ï¸ æŠ€æœ¯æ ˆ

- **æ¡†æ¶**: NestJS 10.x
- **è¯­è¨€**: TypeScript 5.x
- **æ•°æ®åº“**: PostgreSQL 14+
- **ORM**: Prisma 5.x
- **å¯†ç åŠ å¯†**: bcrypt

## ğŸ“ é¡¹ç›®ç»“æ„

```
apps/server/
â”œâ”€â”€ prisma/
â”‚   â”œâ”€â”€ schema.prisma    # æ•°æ®åº“æ¨¡å‹
â”‚   â”œâ”€â”€ seed.ts          # ç§å­æ•°æ®
â”‚   â””â”€â”€ migrations/      # æ•°æ®åº“è¿ç§»
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ config/          # é…ç½®æ¨¡å—
â”‚   â”œâ”€â”€ user/            # ç”¨æˆ·æ¨¡å—
â”‚   â”œâ”€â”€ prisma/          # Prisma æœåŠ¡
â”‚   â”œâ”€â”€ app.module.ts    # æ ¹æ¨¡å—
â”‚   â””â”€â”€ main.ts          # å…¥å£æ–‡ä»¶
â””â”€â”€ package.json
```

## ğŸš€ å¼€å‘æµç¨‹

### 1. åˆ›å»ºæ–°æ¨¡å—

```bash
# ä½¿ç”¨ NestJS CLI
nest generate module your-module
nest generate controller your-module
nest generate service your-module
```

æˆ–æ‰‹åŠ¨åˆ›å»ºï¼š

```typescript
// your-module.service.ts
import { Injectable } from '@nestjs/common';
import { PrismaService } from '../prisma/prisma.service';

@Injectable()
export class YourModuleService {
  constructor(private prisma: PrismaService) {}

  async findAll() {
    return this.prisma.yourModel.findMany();
  }
}
```

```typescript
// your-module.controller.ts
import { Controller, Get } from '@nestjs/common';
import { YourModuleService } from './your-module.service';

@Controller('your-module')
export class YourModuleController {
  constructor(private readonly service: YourModuleService) {}

  @Get()
  findAll() {
    return this.service.findAll();
  }
}
```

```typescript
// your-module.module.ts
import { Module } from '@nestjs/common';
import { YourModuleController } from './your-module.controller';
import { YourModuleService } from './your-module.service';
import { PrismaService } from '../prisma/prisma.service';

@Module({
  controllers: [YourModuleController],
  providers: [YourModuleService, PrismaService],
  exports: [YourModuleService],
})
export class YourModuleModule {}
```

### 2. æ›´æ–°æ•°æ®åº“æ¨¡å‹

ç¼–è¾‘ `prisma/schema.prisma`:

```prisma
model YourModel {
  id        String   @id @default(uuid())
  name      String
  email     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
```

è¿è¡Œè¿ç§»ï¼š

```bash
pnpm prisma migrate dev --name add_your_model
```

### 3. ä½¿ç”¨ Prisma Client

```typescript
// æŸ¥è¯¢
const users = await this.prisma.user.findMany({
  where: { status: true },
  orderBy: { createdAt: 'desc' },
  take: 10,
});

// åˆ›å»º
const user = await this.prisma.user.create({
  data: {
    email: 'user@example.com',
    name: 'User Name',
  },
});

// æ›´æ–°
const updated = await this.prisma.user.update({
  where: { id: userId },
  data: { name: 'New Name' },
});

// åˆ é™¤
await this.prisma.user.delete({
  where: { id: userId },
});
```

## ğŸ“¡ API è®¾è®¡è§„èŒƒ

### RESTful API

```typescript
@Controller('users')
export class UserController {
  @Get()                    // GET /users
  findAll() {}

  @Get(':id')              // GET /users/:id
  findOne(@Param('id') id: string) {}

  @Post()                  // POST /users
  create(@Body() dto: CreateUserDto) {}

  @Put(':id')              // PUT /users/:id
  update(@Param('id') id: string, @Body() dto: UpdateUserDto) {}

  @Patch(':id/status')     // PATCH /users/:id/status
  updateStatus(@Param('id') id: string) {}

  @Delete(':id')           // DELETE /users/:id
  remove(@Param('id') id: string) {}
}
```

### DTO (Data Transfer Object)

```typescript
export interface CreateUserDto {
  email: string;
  name: string;
  password: string;
  role?: 'STUDENT' | 'TEACHER' | 'ADMIN';
}

export interface UpdateUserDto {
  name?: string;
  email?: string;
  role?: 'STUDENT' | 'TEACHER' | 'ADMIN';
}
```

### é”™è¯¯å¤„ç†

```typescript
import { NotFoundException, ConflictException } from '@nestjs/common';

// èµ„æºä¸å­˜åœ¨
if (!user) {
  throw new NotFoundException(`User with ID ${id} not found`);
}

// å†²çªï¼ˆå¦‚é‚®ç®±å·²å­˜åœ¨ï¼‰
if (existingUser) {
  throw new ConflictException('Email already exists');
}
```

## ğŸ—„ï¸ æ•°æ®åº“ç®¡ç†

### Prisma Studio

å¯è§†åŒ–æ•°æ®åº“ç®¡ç†å·¥å…·ï¼š

```bash
pnpm prisma studio
```

è®¿é—® http://localhost:5555

### å¸¸ç”¨å‘½ä»¤

```bash
# ç”Ÿæˆ Prisma Client
pnpm prisma:generate

# åˆ›å»ºè¿ç§»
pnpm prisma migrate dev --name your_migration_name

# åº”ç”¨è¿ç§»ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
pnpm prisma migrate deploy

# é‡ç½®æ•°æ®åº“
pnpm prisma migrate reset

# æ¨é€ schemaï¼ˆä¸åˆ›å»ºè¿ç§»ï¼‰
pnpm prisma:push

# åˆ›å»ºç§å­æ•°æ®
pnpm prisma:seed
```

### æ•°æ®åº“æŸ¥è¯¢

```bash
# è¿æ¥åˆ° PostgreSQL
docker exec -it dong-postgres psql -U postgres -d dong_db

# å¸¸ç”¨ SQL å‘½ä»¤
\dt                    # åˆ—å‡ºæ‰€æœ‰è¡¨
\d "User"             # æŸ¥çœ‹è¡¨ç»“æ„
SELECT * FROM "User"; # æŸ¥è¯¢æ•°æ®
\q                    # é€€å‡º
```

## ğŸ”’ å®‰å…¨æ€§

### å¯†ç åŠ å¯†

```typescript
import * as bcrypt from 'bcrypt';

// åŠ å¯†å¯†ç 
const hashedPassword = await bcrypt.hash(password, 10);

// éªŒè¯å¯†ç 
const isValid = await bcrypt.compare(password, hashedPassword);
```

### ç¯å¢ƒå˜é‡

åˆ›å»º `.env` æ–‡ä»¶ï¼š

```env
DATABASE_URL="postgresql://postgres:postgres@localhost:54320/dong_db?schema=public"
PORT=50000
NODE_ENV=development
```

ä½¿ç”¨ç¯å¢ƒå˜é‡ï¼š

```typescript
const port = process.env.PORT || 3000;
```

## ğŸ§ª æµ‹è¯•

### å•å…ƒæµ‹è¯•

```typescript
describe('UserService', () => {
  let service: UserService;
  let prisma: PrismaService;

  beforeEach(async () => {
    const module = await Test.createTestingModule({
      providers: [UserService, PrismaService],
    }).compile();

    service = module.get<UserService>(UserService);
    prisma = module.get<PrismaService>(PrismaService);
  });

  it('should be defined', () => {
    expect(service).toBeDefined();
  });
});
```

## ğŸ“ æœ€ä½³å®è·µ

### 1. æ¨¡å—åŒ–è®¾è®¡

æ¯ä¸ªåŠŸèƒ½æ¨¡å—ç‹¬ç«‹ï¼ŒåŒ…å«ï¼š
- Controllerï¼ˆè·¯ç”±å¤„ç†ï¼‰
- Serviceï¼ˆä¸šåŠ¡é€»è¾‘ï¼‰
- Moduleï¼ˆæ¨¡å—å®šä¹‰ï¼‰
- DTOï¼ˆæ•°æ®ä¼ è¾“å¯¹è±¡ï¼‰

### 2. ä¾èµ–æ³¨å…¥

```typescript
@Injectable()
export class UserService {
  constructor(
    private prisma: PrismaService,
    private configService: ConfigService,
  ) {}
}
```

### 3. å¼‚å¸¸å¤„ç†

ä½¿ç”¨ NestJS å†…ç½®å¼‚å¸¸ï¼š
- `NotFoundException`
- `BadRequestException`
- `UnauthorizedException`
- `ForbiddenException`
- `ConflictException`

### 4. æ•°æ®éªŒè¯

```typescript
import { IsEmail, IsString, MinLength } from 'class-validator';

export class CreateUserDto {
  @IsEmail()
  email: string;

  @IsString()
  @MinLength(2)
  name: string;

  @IsString()
  @MinLength(8)
  password: string;
}
```

### 5. æŸ¥è¯¢ä¼˜åŒ–

```typescript
// é€‰æ‹©ç‰¹å®šå­—æ®µ
const users = await this.prisma.user.findMany({
  select: {
    id: true,
    name: true,
    email: true,
    // ä¸è¿”å› password
  },
});

// åˆ†é¡µ
const users = await this.prisma.user.findMany({
  skip: (page - 1) * pageSize,
  take: pageSize,
});
```

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [NestJS å®˜æ–¹æ–‡æ¡£](https://docs.nestjs.com/)
- [Prisma å®˜æ–¹æ–‡æ¡£](https://www.prisma.io/docs/)
- [PostgreSQL æ–‡æ¡£](https://www.postgresql.org/docs/)
- [ç”¨æˆ·ç®¡ç†ç³»ç»Ÿ](./05_ç”¨æˆ·ç®¡ç†ç³»ç»Ÿ.md)

---

**æœ€åæ›´æ–°**: 2024-11-24

